///<reference path="../_references.ts"/>
var gulp = require("gulp");
var path = require("path");
var Vinyl = require("vinyl");
var watchdir = require("gulp-watch-dir");
var watch = require("gulp-watch");
var fs = require("fs");
var through2 = require("through2");
var gutil = require("gulp-util");
var reload = require("require-reload")(require);
var prettyTime = require("pretty-time");
var chalk = require("chalk");
var argv = require("yargs")
    .default("task", "default")
    .argv;
var gulpfiles = {};
// Format orchestrator errors
function formatError(e) {
    if (!e.err) {
        return e.message;
    }
    // PluginError
    if (typeof e.err.showStack === "boolean") {
        return e.err.toString();
    }
    // Normal error
    if (e.err.stack) {
        return e.err.stack;
    }
    // Unknown (string, number, etc.)
    return new Error(String(e.err)).stack;
}
// Wire up logging events
function logEvents(gulpInst) {
    // Total hack due to poor error management in orchestrator
    gulpInst.on("err", function () {
        //failed = true;
    });
    gulpInst.on("task_start", function (e) {
        // TODO: batch these
        // so when 5 tasks start at once it only logs one time with all 5
        gutil.log("Starting", "\"" + chalk.cyan(e.task) + "\"...");
    });
    gulpInst.on("task_stop", function (e) {
        var time = prettyTime(e.hrDuration);
        gutil.log("Finished", "\"" + chalk.cyan(e.task) + "\"", "after", chalk.magenta(time));
    });
    gulpInst.on("task_err", function (e) {
        var msg = formatError(e);
        var time = prettyTime(e.hrDuration);
        gutil.log("\"" + chalk.cyan(e.task) + "\"", chalk.red("errored after"), chalk.magenta(time));
        gutil.log(msg);
    });
    gulpInst.on("task_not_found", function (err) {
        gutil.log(chalk.red("Task \"" + err.task + "\" is not in your gulpfile"));
        gutil.log("Please check the documentation for proper gulpfile formatting");
    });
}
gulp.task("test", function () {
    return gulp.src("projects/**/project.xml")
        .pipe(watchdir("**/*.js", {
        ignoreInitial: false,
        verbose: true,
        awaitWriteFinish: { stabilityThreshold: 500 }
    }))
        .pipe(through2.obj(function (f, _, cb) {
        console.log("**** " + f.path);
        var dir = path.dirname(f.path);
        var filepath = path.join(dir, "gulpfile.js");
        this.push(new Vinyl({
            cwd: dir,
            base: dir,
            path: filepath,
            content: fs.createReadStream(filepath)
        }));
        cb();
    }))
        .pipe(through2.obj(function (file, encoding, cb) {
        var _this = this;
        if (gulpfiles[file.path]) {
            gulpfiles[file.path].stop();
            gulpfiles[file.path] = null;
        }
        var gulpfile = reload(file.path);
        logEvents(gulpfile);
        gulpfiles[file.path] = gulpfile;
        process.chdir(path.dirname(file.path));
        setTimeout(function () {
            return gulpfile.start(argv.task, function () {
                gulpfiles[file.path] = null;
                _this.push(file);
                cb();
            });
        }, 0);
    }));
});

//# sourceMappingURL=data:application/json;base64,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QSxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7Z0JBQ3RCLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO2dCQUM1QixLQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNoQixFQUFFLEVBQUUsQ0FBQztZQUNULENBQUMsQ0FBQztRQUpGLENBSUUsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNmLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDWixDQUFDLENBQUMsQ0FBQyIsImZpbGUiOiJndWxwZmlsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLzxyZWZlcmVuY2UgcGF0aD1cIi4uL19yZWZlcmVuY2VzLnRzXCIvPlxyXG5cclxuY29uc3QgZ3VscCA9IHJlcXVpcmUoXCJndWxwXCIpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XHJcbmNvbnN0IFZpbnlsID0gcmVxdWlyZShcInZpbnlsXCIpO1xyXG5jb25zdCB3YXRjaGRpciA9IHJlcXVpcmUoXCJndWxwLXdhdGNoLWRpclwiKTtcclxuY29uc3Qgd2F0Y2ggPSByZXF1aXJlKFwiZ3VscC13YXRjaFwiKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKFwiZnNcIik7XHJcbmNvbnN0IHRocm91Z2gyID0gcmVxdWlyZShcInRocm91Z2gyXCIpO1xyXG5jb25zdCBndXRpbCA9IHJlcXVpcmUoXCJndWxwLXV0aWxcIik7XHJcbmNvbnN0IHJlbG9hZCA9IHJlcXVpcmUoXCJyZXF1aXJlLXJlbG9hZFwiKShyZXF1aXJlKTtcclxuY29uc3QgcHJldHR5VGltZSA9IHJlcXVpcmUoXCJwcmV0dHktdGltZVwiKTtcclxuY29uc3QgY2hhbGsgPSByZXF1aXJlKFwiY2hhbGtcIik7XHJcbmNvbnN0IGFyZ3YgPSByZXF1aXJlKFwieWFyZ3NcIilcclxuICAgIC5kZWZhdWx0KFwidGFza1wiLCBcImRlZmF1bHRcIilcclxuICAgIC5hcmd2O1xyXG5cclxudmFyIGd1bHBmaWxlcyA9IHt9O1xyXG5cclxuLy8gRm9ybWF0IG9yY2hlc3RyYXRvciBlcnJvcnNcclxuZnVuY3Rpb24gZm9ybWF0RXJyb3IoZSkge1xyXG4gICAgaWYgKCFlLmVycikge1xyXG4gICAgICAgIHJldHVybiBlLm1lc3NhZ2U7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUGx1Z2luRXJyb3JcclxuICAgIGlmICh0eXBlb2YgZS5lcnIuc2hvd1N0YWNrID09PSBcImJvb2xlYW5cIikge1xyXG4gICAgICAgIHJldHVybiBlLmVyci50b1N0cmluZygpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIE5vcm1hbCBlcnJvclxyXG4gICAgaWYgKGUuZXJyLnN0YWNrKSB7XHJcbiAgICAgICAgcmV0dXJuIGUuZXJyLnN0YWNrO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFVua25vd24gKHN0cmluZywgbnVtYmVyLCBldGMuKVxyXG4gICAgcmV0dXJuIG5ldyBFcnJvcihTdHJpbmcoZS5lcnIpKS5zdGFjaztcclxufVxyXG5cclxuLy8gV2lyZSB1cCBsb2dnaW5nIGV2ZW50c1xyXG5mdW5jdGlvbiBsb2dFdmVudHMoZ3VscEluc3QpIHtcclxuXHJcbiAgICAvLyBUb3RhbCBoYWNrIGR1ZSB0byBwb29yIGVycm9yIG1hbmFnZW1lbnQgaW4gb3JjaGVzdHJhdG9yXHJcbiAgICBndWxwSW5zdC5vbihcImVyclwiLCAoKSA9PiB7XHJcbiAgICAgICAgLy9mYWlsZWQgPSB0cnVlO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZ3VscEluc3Qub24oXCJ0YXNrX3N0YXJ0XCIsIGUgPT4ge1xyXG4gICAgICAgIC8vIFRPRE86IGJhdGNoIHRoZXNlXHJcbiAgICAgICAgLy8gc28gd2hlbiA1IHRhc2tzIHN0YXJ0IGF0IG9uY2UgaXQgb25seSBsb2dzIG9uZSB0aW1lIHdpdGggYWxsIDVcclxuICAgICAgICBndXRpbC5sb2coXCJTdGFydGluZ1wiLCBcIlxcXCJcIiArIGNoYWxrLmN5YW4oZS50YXNrKSArIFwiXFxcIi4uLlwiKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGd1bHBJbnN0Lm9uKFwidGFza19zdG9wXCIsIGUgPT4ge1xyXG4gICAgICAgIHZhciB0aW1lID0gcHJldHR5VGltZShlLmhyRHVyYXRpb24pO1xyXG4gICAgICAgIGd1dGlsLmxvZyhcclxuICAgICAgICAgICAgXCJGaW5pc2hlZFwiLCBcIlxcXCJcIiArIGNoYWxrLmN5YW4oZS50YXNrKSArIFwiXFxcIlwiLFxyXG4gICAgICAgICAgICBcImFmdGVyXCIsIGNoYWxrLm1hZ2VudGEodGltZSlcclxuICAgICAgICApO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZ3VscEluc3Qub24oXCJ0YXNrX2VyclwiLCBlID0+IHtcclxuICAgICAgICB2YXIgbXNnID0gZm9ybWF0RXJyb3IoZSk7XHJcbiAgICAgICAgdmFyIHRpbWUgPSBwcmV0dHlUaW1lKGUuaHJEdXJhdGlvbik7XHJcbiAgICAgICAgZ3V0aWwubG9nKFxyXG4gICAgICAgICAgICBcIlxcXCJcIiArIGNoYWxrLmN5YW4oZS50YXNrKSArIFwiXFxcIlwiLFxyXG4gICAgICAgICAgICBjaGFsay5yZWQoXCJlcnJvcmVkIGFmdGVyXCIpLFxyXG4gICAgICAgICAgICBjaGFsay5tYWdlbnRhKHRpbWUpXHJcbiAgICAgICAgKTtcclxuICAgICAgICBndXRpbC5sb2cobXNnKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGd1bHBJbnN0Lm9uKFwidGFza19ub3RfZm91bmRcIiwgZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgIGd1dGlsLmxvZyhcclxuICAgICAgICAgICAgY2hhbGsucmVkKFwiVGFzayBcXFwiXCIgKyBlcnIudGFzayArIFwiXFxcIiBpcyBub3QgaW4geW91ciBndWxwZmlsZVwiKVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgZ3V0aWwubG9nKFwiUGxlYXNlIGNoZWNrIHRoZSBkb2N1bWVudGF0aW9uIGZvciBwcm9wZXIgZ3VscGZpbGUgZm9ybWF0dGluZ1wiKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5ndWxwLnRhc2soXCJ0ZXN0XCIsIGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiBndWxwLnNyYyhcInByb2plY3RzLyoqL3Byb2plY3QueG1sXCIpXHJcbiAgICAgICAgLnBpcGUod2F0Y2hkaXIoXCIqKi8qLmpzXCIsIHtcclxuICAgICAgICAgICAgaWdub3JlSW5pdGlhbDogZmFsc2UsXHJcbiAgICAgICAgICAgIHZlcmJvc2U6IHRydWUsXHJcbiAgICAgICAgICAgIGF3YWl0V3JpdGVGaW5pc2g6IHtzdGFiaWxpdHlUaHJlc2hvbGQ6IDUwMH1cclxuICAgICAgICB9KSlcclxuICAgICAgICAucGlwZSh0aHJvdWdoMi5vYmooZnVuY3Rpb24gKGYsIF8sIGNiKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiKioqKiBcIiArIGYucGF0aCk7XHJcbiAgICAgICAgICAgIHZhciBkaXIgPSBwYXRoLmRpcm5hbWUoZi5wYXRoKTtcclxuICAgICAgICAgICAgdmFyIGZpbGVwYXRoID0gcGF0aC5qb2luKGRpciwgXCJndWxwZmlsZS5qc1wiKTtcclxuICAgICAgICAgICAgdGhpcy5wdXNoKG5ldyBWaW55bCh7XHJcbiAgICAgICAgICAgICAgICBjd2Q6IGRpcixcclxuICAgICAgICAgICAgICAgIGJhc2U6IGRpcixcclxuICAgICAgICAgICAgICAgIHBhdGg6IGZpbGVwYXRoLFxyXG4gICAgICAgICAgICAgICAgY29udGVudDogZnMuY3JlYXRlUmVhZFN0cmVhbShmaWxlcGF0aClcclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICBjYigpO1xyXG4gICAgICAgIH0pKVxyXG4gICAgICAgIC5waXBlKHRocm91Z2gyLm9iaihmdW5jdGlvbiAoZmlsZSwgZW5jb2RpbmcsIGNiKSB7XHJcbiAgICAgICAgICAgIGlmIChndWxwZmlsZXNbZmlsZS5wYXRoXSkge1xyXG4gICAgICAgICAgICAgICAgZ3VscGZpbGVzW2ZpbGUucGF0aF0uc3RvcCgpO1xyXG4gICAgICAgICAgICAgICAgZ3VscGZpbGVzW2ZpbGUucGF0aF0gPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBndWxwZmlsZSA9IHJlbG9hZChmaWxlLnBhdGgpO1xyXG4gICAgICAgICAgICBsb2dFdmVudHMoZ3VscGZpbGUpO1xyXG5cclxuICAgICAgICAgICAgZ3VscGZpbGVzW2ZpbGUucGF0aF0gPSBndWxwZmlsZTtcclxuICAgICAgICAgICAgcHJvY2Vzcy5jaGRpcihwYXRoLmRpcm5hbWUoZmlsZS5wYXRoKSk7XHJcblxyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpPT5cclxuICAgICAgICAgICAgICAgIGd1bHBmaWxlLnN0YXJ0KGFyZ3YudGFzaywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGd1bHBmaWxlc1tmaWxlLnBhdGhdID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnB1c2goZmlsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2IoKTtcclxuICAgICAgICAgICAgICAgIH0pLCAwKTtcclxuICAgICAgICB9KSk7XHJcbn0pOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
