///<reference path="../_references.ts"/>
var extend = require('extend');
var gutil = require('gulp-util');
var through2 = require('through2');
var path = require('path');
var chokidar = require('chokidar');
var vfs = require('vinyl-fs');
var PluginError = gutil.PluginError;
var watcherEvents = ['add', 'change', 'unlink', 'addDir', 'unlinkDir', 'error', 'ready', 'raw'];
// normalizeGlobs()  from https://github.com/floatdrop/gulp-watch/blob/master/index.js
function normalizeGlobs(globs) {
    if (!globs) {
        throw new PluginError('gulp-watch-dir', 'glob option required');
    }
    if (typeof globs === 'string') {
        globs = [globs];
    }
    if (!Array.isArray(globs)) {
        throw new PluginError('gulp-watch-dir', 'glob should be String or Array, not ' + (typeof globs));
    }
    return globs;
}
function processEvent(callback, ev, inputFile, filepath) {
    var _this = this;
    gutil.log("File system event " + gutil.colors.magenta(ev) + " for file " + gutil.colors.magenta(filepath));
    var file = vfs.src(filepath)
        .on('data', function () { return _this.push(inputFile); })
        .on('error', this.emit.bind(this, 'error'))
        .on('end', function () {
        gutil.log("File " + gutil.colors.magenta(filepath) + " read.");
        if (callback) {
            callback(ev, inputFile, filepath);
        }
    });
}
function watchdir(glob, options, callback) {
    if (!glob) {
        throw new PluginError('gulp-watch-dir', 'glob argument required');
    }
    glob = normalizeGlobs(glob);
    var args = {};
    [options, callback].slice(1, 2).forEach(function (a) { return args[typeof a] = a; });
    callback = args["function"];
    options = extend({
        map: function (f) { return f.path; },
        events: ['add', 'change', 'unlink']
    }, args["object"] || {});
    return through2.obj(function (file, encoding, done) {
        var _this = this;
        var dir = file.isDirectory()
            ? file.path
            : path.dirname(file.path);
        var relativeGlob = glob.map(function (g) { return path.join(dir, g); });
        if (options.verbose) {
            gutil.log("Watching directory " + gutil.colors.magenta(dir) + ":\r\n" + JSON.stringify(relativeGlob, null, 4));
        }
        var watcher = chokidar.watch(relativeGlob, options);
        options.events.forEach(function (ev) { return watcher.on(ev, processEvent.bind(_this, callback, ev, file)); });
        watcherEvents.forEach(function (ev) { return watcher.on(ev, _this.emit.bind(_this, ev)); });
        this.unwatch = watcher.unwatch.bind(watcher);
        this.close = function () {
            watcher.close();
            _this.emit('end');
        };
    });
}
module.exports = watchdir;

//# sourceMappingURL=data:application/json;base64,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Q0FBQztRQUVELElBQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRXRELE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQUEsRUFBRSxJQUFJLE9BQUEsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFJLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQyxFQUEzRCxDQUEyRCxDQUFDLENBQUM7UUFDMUYsYUFBYSxDQUFDLE9BQU8sQ0FBQyxVQUFBLEVBQUUsSUFBRyxPQUFBLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLEtBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUF4QyxDQUF3QyxDQUFDLENBQUM7UUFFckUsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU3QyxJQUFJLENBQUMsS0FBSyxHQUFHO1lBQ1QsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2hCLEtBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDckIsQ0FBQyxDQUFDO0lBQ04sQ0FBQyxDQUNKLENBQUM7QUFDTixDQUFDO0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUMiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy88cmVmZXJlbmNlIHBhdGg9XCIuLi9fcmVmZXJlbmNlcy50c1wiLz5cclxuXHJcbmNvbnN0IGV4dGVuZCA9IHJlcXVpcmUoJ2V4dGVuZCcpO1xyXG5jb25zdCBndXRpbCA9IHJlcXVpcmUoJ2d1bHAtdXRpbCcpO1xyXG5jb25zdCB0aHJvdWdoMiA9IHJlcXVpcmUoJ3Rocm91Z2gyJyk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcbmNvbnN0IGNob2tpZGFyID0gcmVxdWlyZSgnY2hva2lkYXInKTtcclxuY29uc3QgdmZzID0gcmVxdWlyZSgndmlueWwtZnMnKTtcclxuXHJcbmNvbnN0IFBsdWdpbkVycm9yID0gZ3V0aWwuUGx1Z2luRXJyb3I7XHJcbmNvbnN0IHdhdGNoZXJFdmVudHMgPSBbJ2FkZCcsICdjaGFuZ2UnLCAndW5saW5rJywgJ2FkZERpcicsICd1bmxpbmtEaXInLCAnZXJyb3InLCAncmVhZHknLCAncmF3J107XHJcblxyXG4vLyBub3JtYWxpemVHbG9icygpICBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9mbG9hdGRyb3AvZ3VscC13YXRjaC9ibG9iL21hc3Rlci9pbmRleC5qc1xyXG5mdW5jdGlvbiBub3JtYWxpemVHbG9icyhnbG9icykge1xyXG4gICAgaWYgKCFnbG9icykge1xyXG4gICAgICAgIHRocm93IG5ldyBQbHVnaW5FcnJvcignZ3VscC13YXRjaC1kaXInLCAnZ2xvYiBvcHRpb24gcmVxdWlyZWQnKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodHlwZW9mIGdsb2JzID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgIGdsb2JzID0gW2dsb2JzXTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZ2xvYnMpKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IFBsdWdpbkVycm9yKCdndWxwLXdhdGNoLWRpcicsICdnbG9iIHNob3VsZCBiZSBTdHJpbmcgb3IgQXJyYXksIG5vdCAnICsgKHR5cGVvZiBnbG9icykpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBnbG9icztcclxufVxyXG5cclxuZnVuY3Rpb24gcHJvY2Vzc0V2ZW50KGNhbGxiYWNrLCBldiwgaW5wdXRGaWxlLCBmaWxlcGF0aCkge1xyXG4gICAgZ3V0aWwubG9nKGBGaWxlIHN5c3RlbSBldmVudCAke2d1dGlsLmNvbG9ycy5tYWdlbnRhKGV2KX0gZm9yIGZpbGUgJHtndXRpbC5jb2xvcnMubWFnZW50YShmaWxlcGF0aCl9YCk7XHJcbiAgICBjb25zdCBmaWxlID0gdmZzLnNyYyhmaWxlcGF0aClcclxuICAgICAgICAub24oJ2RhdGEnLCAoKSA9PiB0aGlzLnB1c2goaW5wdXRGaWxlKSlcclxuICAgICAgICAub24oJ2Vycm9yJywgdGhpcy5lbWl0LmJpbmQodGhpcywgJ2Vycm9yJykpXHJcbiAgICAgICAgLm9uKCdlbmQnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGd1dGlsLmxvZyhgRmlsZSAke2d1dGlsLmNvbG9ycy5tYWdlbnRhKGZpbGVwYXRoKX0gcmVhZC5gKTtcclxuICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhldiwgaW5wdXRGaWxlLCBmaWxlcGF0aCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gd2F0Y2hkaXIoZ2xvYiwgb3B0aW9ucz8sIGNhbGxiYWNrPykge1xyXG4gICAgaWYgKCFnbG9iKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IFBsdWdpbkVycm9yKCdndWxwLXdhdGNoLWRpcicsICdnbG9iIGFyZ3VtZW50IHJlcXVpcmVkJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2xvYiA9IG5vcm1hbGl6ZUdsb2JzKGdsb2IpO1xyXG5cclxuICAgIGNvbnN0IGFyZ3MgPSB7fTtcclxuICAgIFtvcHRpb25zLCBjYWxsYmFja10uc2xpY2UoMSwgMikuZm9yRWFjaChhPT5hcmdzW3R5cGVvZiBhXSA9IGEpO1xyXG5cclxuICAgIGNhbGxiYWNrID0gYXJnc1tcImZ1bmN0aW9uXCJdO1xyXG4gICAgb3B0aW9ucyA9IGV4dGVuZCh7XHJcbiAgICAgICAgbWFwOiBmID0+IGYucGF0aCxcclxuICAgICAgICBldmVudHM6IFsnYWRkJywgJ2NoYW5nZScsICd1bmxpbmsnXVxyXG4gICAgfSwgYXJnc1tcIm9iamVjdFwiXSB8fCB7fSk7XHJcblxyXG4gICAgcmV0dXJuIHRocm91Z2gyLm9iaihmdW5jdGlvbiAoZmlsZSwgZW5jb2RpbmcsIGRvbmUpIHtcclxuICAgICAgICAgICAgY29uc3QgZGlyID0gZmlsZS5pc0RpcmVjdG9yeSgpXHJcbiAgICAgICAgICAgICAgICA/IGZpbGUucGF0aFxyXG4gICAgICAgICAgICAgICAgOiBwYXRoLmRpcm5hbWUoZmlsZS5wYXRoKTtcclxuICAgICAgICAgICAgY29uc3QgcmVsYXRpdmVHbG9iID0gZ2xvYi5tYXAoZyA9PiBwYXRoLmpvaW4oZGlyLCBnKSk7XHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnZlcmJvc2UpIHtcclxuICAgICAgICAgICAgICAgIGd1dGlsLmxvZyhgV2F0Y2hpbmcgZGlyZWN0b3J5ICR7Z3V0aWwuY29sb3JzLm1hZ2VudGEoZGlyKX06XFxyXFxuJHtKU09OLnN0cmluZ2lmeShyZWxhdGl2ZUdsb2IsIG51bGwsIDQpfWApO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCB3YXRjaGVyID0gY2hva2lkYXIud2F0Y2gocmVsYXRpdmVHbG9iLCBvcHRpb25zKTtcclxuXHJcbiAgICAgICAgICAgIG9wdGlvbnMuZXZlbnRzLmZvckVhY2goZXYgPT4gd2F0Y2hlci5vbihldiwgcHJvY2Vzc0V2ZW50LmJpbmQodGhpcywgY2FsbGJhY2ssIGV2LCBmaWxlKSkpO1xyXG4gICAgICAgICAgICB3YXRjaGVyRXZlbnRzLmZvckVhY2goZXYgPT53YXRjaGVyLm9uKGV2LCB0aGlzLmVtaXQuYmluZCh0aGlzLCBldikpKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMudW53YXRjaCA9IHdhdGNoZXIudW53YXRjaC5iaW5kKHdhdGNoZXIpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5jbG9zZSA9ICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHdhdGNoZXIuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnZW5kJyk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgKTtcclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSB3YXRjaGRpcjsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
